<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Add Balance to Pay - printRoute</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet"><link rel="stylesheet" href="assets/css/styles.css"></head>
<body class="d-flex align-items-center py-4 bg-body-tertiary">
    <main class="w-100 m-auto" style="max-width: 450px;">
        <div class="form-container">
            <div class="text-center mb-4">
                    <img style="display: inline-block; margin-top: 20px;" class="mb-4" src="assets/images/logo.png" alt="printRoute Logo" height="57">
                    <img src="assets/images/name.jpg" alt="printRoute Name" height="44">    
                <h1 class="h3 mb-3 fw-normal">Insufficient Balance</h1></div>
            <div class="card mb-4">
                <div class="card-body">
                    <p class="d-flex justify-content-between"><span>Deposit Needed:</span> <strong id="depositAmount">₹0.00</strong></p>
                    <p class="d-flex justify-content-between"><span>Current Balance:</span> <strong id="currentBalance">₹0.00</strong></p>
                    <hr>
                    <p class="d-flex justify-content-between text-danger"><span>Amount Short:</span> <strong id="amountShort">₹0.00</strong></p>
                </div>
            </div>
            <div class="form-floating mb-3">
                <input type="number" class="form-control" id="amountToAdd" placeholder="100" min="1">
                <label for="amountToAdd">Amount to Add (₹)</label>
            </div>
            <div class="d-grid">
                <button id="payBtn" class="btn btn-primary btn-lg">Add Balance & Pay</button>
            </div>
        </div>
    </main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const orderDetails = JSON.parse(localStorage.getItem('printOrderDetails'));
        if (!orderDetails) { window.location.href = 'upload_pdf.php'; return; }

        const walletBalance = parseFloat(localStorage.getItem('userWalletBalance')) || 0;
        const depositNeeded = orderDetails.totalDeposit;
        const amountShort = depositNeeded - walletBalance;

        // Populate the summary
        document.getElementById('depositAmount').textContent = `₹${depositNeeded.toFixed(2)}`;
        document.getElementById('currentBalance').textContent = `₹${walletBalance.toFixed(2)}`;
        const payBtn = document.getElementById('payBtn');

        // ***** NEW LOGIC TO HANDLE SUFFICIENT BALANCE *****
        if (amountShort <= 0) {
            // User has enough balance but landed here. Show a direct payment option.
            document.querySelector('.h3').textContent = 'Confirm Payment';
            document.getElementById('amountShort').parentElement.innerHTML = '<span class="text-success">You have sufficient balance to pay directly.</span>';
            document.getElementById('amountToAdd').parentElement.style.display = 'none'; // Hide the input
            payBtn.textContent = 'Pay with Wallet';
            
            payBtn.addEventListener('click', function() {
                // Simple deduction logic
                localStorage.setItem('userWalletBalance', walletBalance - depositNeeded);
                orderDetails.paid = true;
                localStorage.setItem('printOrderDetails', JSON.stringify(orderDetails));
                alert('Payment successful from wallet!');
                window.location.href = 'select_shop.php';
            });

        } else {
            // Original logic for insufficient balance
            document.getElementById('amountShort').textContent = `₹${amountShort.toFixed(2)}`;
            document.getElementById('amountToAdd').value = Math.ceil(amountShort);

            payBtn.addEventListener('click', function() {
                const amountToAdd = parseFloat(document.getElementById('amountToAdd').value);
                if (isNaN(amountToAdd) || amountToAdd < amountShort) {
                    alert(`Please add at least ₹${amountShort.toFixed(2)} to proceed.`);
                    return;
                }
                const newBalance = walletBalance + amountToAdd;
                const finalBalance = newBalance - depositNeeded;
                localStorage.setItem('userWalletBalance', finalBalance);
                orderDetails.paid = true;
                localStorage.setItem('printOrderDetails', JSON.stringify(orderDetails));
                alert('Balance added and payment successful!');
                window.location.href = 'select_shop.php';
            });
        }
    });
</script>
</body>
</html>